<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Vermenigvuldigen â€” cijferen (live hints + checks)</title>
<style>
  :root{
    --bg:#f7f8fb; --card:#ffffff; --ink:#111;
    --line:#cbd5e1; --accent:#2563eb; --muted:#4b5563;
    --bad:#fde8e8; --good:#e6f7f1; --hint:#fff7ed; --hint2:#fef3c7;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; background:var(--bg); color:var(--ink); font-family:Arial, Helvetica, sans-serif; }
  .wrap{ max-width:900px; margin:auto; padding:20px; }
  .card{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; box-shadow:0 6px 20px rgba(0,0,0,.06); }

  h1{ margin:0 0 8px; font-size:22px; }

  .bar{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:10px; }
  .bar select, .bar input[type="checkbox"]{ transform: translateY(1px); }
  .bar label{ color:#0f172a; }

  button{
    padding:10px 14px; border:none; border-radius:8px; background:var(--accent); color:#fff; font-weight:600; cursor:pointer;
  }
  input[type="text"]{
    padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px; min-width:200px; font-size:16px;
  }

  /* Opgave + inline antwoord */
  .task-row{
    display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    margin:10px 0 6px;
  }
  .task-label{ font-size:24px; font-weight:700; }
  .task-ans{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  #btn-swap{ background:#374151; }

  /* --- Rooster --- */
  .grid{ border-collapse:collapse; margin-top:8px; }
  .grid td{
    border:1px solid var(--line);
    width:32px; height:36px; text-align:center; vertical-align:middle;
  }
  .grid input{
    width:100%; height:100%;
    border:none; outline:none;
    background:transparent;
    text-align:center; font-size:16px;
  }
  /* ENKEL de uiterst linkse kolom lichtgrijs (klad/carry) */
  .grid td.first-col input{
    background:#f1f5f9; color:#0f172a;
  }

  /* Dikke lijnen op rij-niveau (geen extra scheidingsrij!!) */
  .grid tr.thick-after td  { border-bottom:3px solid #111; }
  .grid tr.thick-before td { border-top:   3px solid #111; }

  /* Feedback-blokken */
  .okmsg{ background:#e6f7f1; border:1px solid #c7ecde; padding:8px 10px; border-radius:8px; margin-top:10px; }
  .warnmsg{ background:#fff7ed; border:1px solid #fed7aa; padding:8px 10px; border-radius:8px; margin-top:10px; }
  .errmsg{ background:#fde8e8; border:1px solid #f7caca; padding:8px 10px; border-radius:8px; margin-top:10px; }

  /* Per-cel fout (na Nakijken) */
  .badcell input{ background: var(--bad) !important; }

  /* Live hints (tijdens invullen) */
  .live-hints{
    background:var(--hint);
    border:1px solid #fed7aa;
    padding:8px 10px; border-radius:8px;
    margin-top:8px; font-size:14px; color:#7c2d12;
  }
  .wrong-shift input{ background: var(--hint2) !important; } /* rechts: er staat iets â‰  0 */

  /* Som-rij laten knipperen bij verschil met antwoord */
  @keyframes sumRowBlink {
    0%, 100% { background-color: var(--bad); }
    50%      { background-color: transparent; }
  }
  .sum-blink td { animation: sumRowBlink 0.9s ease-in-out 4; }

  .note{ margin-top:8px; font-size:13px; color:#334155; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Vermenigvuldigen â€” cijferen</h1>

  <div class="card">
    <!-- Moeilijkheid + toggles -->
    <div class="bar">
      <label for="difficulty"><b>Moeilijkheid:</b></label>
      <select id="difficulty">
        <option value="makkelijk">Makkelijk (10â€“100, max 1 dec)</option>
        <option value="gemiddeld">Gemiddeld (10â€“1000, max 2 dec)</option>
        <option value="moeilijk" selected>Moeilijk (10â€“1000, max 3 dec)</option>
      </select>

      <label><input type="checkbox" id="allowDec" checked> Decimale getallen toestaan</label>
      <label><input type="checkbox" id="prefillOperands"> Opgave in rooster tonen</label>
      <label><input type="checkbox" id="allowSwap"> Omdraaien toestaan</label>

      <button id="btn-new">Nieuwe oefening</button>
    </div>

    <!-- Opgave + inline antwoord + omdraaien -->
    <div class="task-row">
      <div class="task-label" id="task">â€”</div>
      <button id="btn-swap" style="display:none" title="Wissel A en B">â†” Omdraaien</button>
      <div class="task-ans">
        <input id="answer" type="text" placeholder="bv. 123,45 of 123.45">
        <button id="btn-check">Nakijken</button>
      </div>
    </div>

    <div id="grid"></div>
    <div id="grid-note" class="note"></div>
    <div id="live-hints" class="live-hints" style="display:none"></div>

    <div id="feedback"></div>
  </div>
</div>

<script>
/* ===== Helpers ===== */
function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
function formatWithComma(rawStr, decs){
  let s = String(rawStr);
  if (decs <= 0) return s;
  if (s.length <= decs) s = s.padStart(decs+1, '0');
  const pos = s.length - decs;
  let out = s.slice(0,pos) + ',' + s.slice(pos);
  out = out.replace(/,?0+$/,'').replace(/,$/,'');
  return out;
}
function normalizeStudent(s){
  if(!s) return '';
  return String(s).trim()
    .replace(/\s+/g,'')
    .replace(/\./g,',')
    .replace(/^0+(?=\d)/,'')
    .replace(/,?0+$/,'')
    .replace(/,$/,'');
}
function onlyDigits(s){ return String(s||'').replace(/[^\d]/g,''); }

/* ===== Moeilijkheidsconfig ===== */
const DIFF = {
  makkelijk: { min:10,  max:100,  decMax:1 },
  gemiddeld: { min:10,  max:1000, decMax:2 },
  moeilijk:  { min:10,  max:1000, decMax:3 }
};

let current = null;           // { a:{raw,decs}, b:{raw,decs}, productRaw, productDecs }
let currentDiff = 'moeilijk';
let allowDec = true;
let prefillOperands = false;
let allowSwap = false;

/* Getal binnen 10..max, met 0..decMax decim., 1000 => geen decim. */
function makeNumberBounded(cfg){
  const intPart = randInt(cfg.min, cfg.max);
  let decs = allowDec ? randInt(0, cfg.decMax) : 0;
  if (intPart === cfg.max) decs = 0;
  const decPart = decs>0 ? String(randInt(0,10**decs-1)).padStart(decs,'0') : '';
  const raw = String(intPart) + decPart;
  const shown = formatWithComma(raw, decs);
  return { raw, decs, shown };
}

/* ===== Oefening (1 per keer) ===== */
function newExercise(){
  const cfg = DIFF[currentDiff] || DIFF.moeilijk;
  const a = makeNumberBounded(cfg);
  const b = makeNumberBounded(cfg);
  const productRaw  = String(Number(a.raw) * Number(b.raw));
  const productDecs = a.decs + b.decs;

  current = { a:{raw:a.raw,decs:a.decs}, b:{raw:b.raw,decs:b.decs}, productRaw, productDecs };

  document.getElementById('task').textContent = `${a.shown} Ã— ${b.shown} =`;
  document.getElementById('answer').value = '';
  document.getElementById('feedback').innerHTML = '';

  updateSwapVisibility();
  buildGrid(current);
}

/* ===== Rooster (bouw + pijltjes) ===== */
function buildGrid(item){
  const aDigits = item.a.raw.split('');
  const bDigits = item.b.raw.split('');
  const aLen = aDigits.length, bLen = bDigits.length;
  const cols = 1 + aLen + bLen; // 1 grijs + kern + shift

  const td = (html='', cls='') => `<td class="${cls}">${html}</td>`;

  // Factor A
  const rowA = (() => {
    const blanks = (cols - 1) - aLen;
    const first = td(`<input class="first-col" value="" ${prefillOperands?'readonly':''}>`,'first-col');
    if (prefillOperands){
      const left = Array.from({length:blanks}).map(()=>td('')).join('');
      const body = aDigits.map(d=>td(`<input value="${d}" readonly>`)).join('');
      return `<tr>${first}${left}${body}</tr>`;
    }else{
      let rowHtml = '';
      for(let c=1;c<cols;c++) rowHtml += td(`<input data-r="-2" data-c="${c}" inputmode="numeric" pattern="[0-9]*" maxlength="1">`);
      return `<tr>${first}${rowHtml}</tr>`;
    }
  })();

  // Factor B (+ dikke lijn)
  const rowB = (() => {
    const blanks = (cols - 1) - bLen;
    const first = td(`<input class="first-col" value="" ${prefillOperands?'readonly':''}>`,'first-col');
    if (prefillOperands){
      const left = Array.from({length:blanks}).map(()=>td('')).join('');
      const body = bDigits.map(d=>td(`<input value="${d}" readonly>`)).join('');
      return `<tr class="thick-after">${first}${left}${body}</tr>`;
    }else{
      let rowHtml = '';
      for(let c=1;c<cols;c++) rowHtml += td(`<input data-r="-1" data-c="${c}" inputmode="numeric" pattern="[0-9]*" maxlength="1">`);
      return `<tr class="thick-after">${first}${rowHtml}</tr>`;
    }
  })();

  // Tussenproducten
  let partials = '';
  for(let r=0;r<bLen;r++){
    let rowHtml = '';
    for(let c=0;c<cols;c++){
      const isFirst = (c===0); const cls = isFirst?'first-col':'';
      rowHtml += td(`<input data-r="${r}" data-c="${c}" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="${cls}">`, cls);
    }
    partials += `<tr>${rowHtml}</tr>`;
  }

  // Somâ€‘rij (+ dikke lijn)
  const rowSum = (() => {
    const r=bLen; let rowHtml='';
    for(let c=0;c<cols;c++){
      const isFirst = (c===0); const cls = isFirst?'first-col':'';
      rowHtml += td(`<input data-r="${r}" data-c="${c}" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="${cls}">`, cls);
    }
    return `<tr class="thick-before">${rowHtml}</tr>`;
  })();

  const html = `
    <table class="grid" id="grid-table" data-cols="${cols}" data-a="${aDigits.join('')}" data-b="${bDigits.join('')}">
      ${rowA}
      ${rowB}
      ${partials}
      ${rowSum}
    </table>
  `;
  const gridDiv = document.getElementById('grid');
  gridDiv.innerHTML = html;

  // Reset hints bij (her)opbouw
  const hintsBox = document.getElementById('live-hints');
  if (hintsBox){ hintsBox.style.display='none'; hintsBox.innerHTML=''; }

  // Nota
  document.getElementById('grid-note').textContent =
    'Opmerking: de lichtgrijze vakjes in de uiterst linkse kolom zijn bedoeld om tijdelijk meeneemcijfers (â€œonthoudenâ€) te noteren.';

  // Pijltjesâ€‘navigatie
  const gridEl = document.getElementById('grid');
  gridEl.addEventListener('keydown',(e)=>{
    const t=e.target; if(!(t instanceof HTMLInputElement)) return;
    const rAttr=t.getAttribute('data-r'), cAttr=t.getAttribute('data-c');
    if(rAttr===null||cAttr===null) return;
    const r=Number(rAttr), c=Number(cAttr);
    const table=document.getElementById('grid-table');
    const colsCount=Number(table.getAttribute('data-cols'));
    const minR = prefillOperands?0:-2;
    const inputs = gridEl.querySelectorAll('input[data-r]');
    let maxR=0; inputs.forEach(inp=>{const rv=Number(inp.getAttribute('data-r')); if(!Number.isNaN(rv)&&rv>maxR) maxR=rv;});
    let nr=r, nc=c;
    if(e.key==='ArrowLeft'){ nc=Math.max(1,c-1); e.preventDefault(); }
    else if(e.key==='ArrowRight'){ nc=Math.min(colsCount-1,c+1); e.preventDefault(); }
    else if(e.key==='ArrowUp'){ nr=Math.max(minR,r-1); e.preventDefault(); }
    else if(e.key==='ArrowDown'){ nr=Math.min(maxR,r+1); e.preventDefault(); }
    else return;
    const next=gridEl.querySelector(`input[data-r="${nr}"][data-c="${nc}"]`); if(next) next.focus();
  });

  // Live hints tijdens invullen
  gridEl.addEventListener('input',(e)=>{ if(e.target instanceof HTMLInputElement) validateShiftZerosOnly(); });
}

/* Live hint: enkel bij â‰  0 in rechter shift-vakken */
function _placeLabel(k){
  if (k === 1) return 'tiental';
  if (k === 2) return 'honderdtal';
  if (k === 3) return 'duizendtal';
  return `Ã—10^${k}`;
}
function validateShiftZerosOnly() {
  const table = document.getElementById('grid-table');
  const hintsBox = document.getElementById('live-hints');
  if (!table || !hintsBox) return;

  const cols = Number(table.getAttribute('data-cols'));
  const bStr = table.getAttribute('data-b') || '';
  const bLen = bStr.length;

  // Reset oude markeringen
  table.querySelectorAll('td').forEach(td => td.classList.remove('wrong-shift'));

  const messages = [];

  for (let r = 0; r < bLen; r++) {
    const k = r;
    if (k <= 0) continue; // geen shift-positie

    let anyWrong = false;

    // Rechter k kolommen: c = cols - k .. cols - 1
    for (let c = cols - k; c < cols; c++) {
      const inp = table.querySelector(`input[data-r="${r}"][data-c="${c}"]`);
      if (!inp) continue;
      const val = (inp.value || '').trim();

      // Alleen tip bij expliciet â‰  '0' (leeg = nog niks ingevuld â†’ geen tip)
      if (val !== '' && val !== '0') {
        anyWrong = true;
        const td = inp.parentElement; if (td) td.classList.add('wrong-shift');
      }
    }

    if (anyWrong) {
      messages.push(
        `Rij ${r + 1}: rechts horen ${k} nul(len) te staan, ` +
        `<b>omdat je vermenigvuldigt met een ${_placeLabel(k)}</b>.`
      );
    }
  }

  if (messages.length) {
    hintsBox.style.display = 'block';
    hintsBox.innerHTML = 'ðŸŸ  <b>Tip:</b> ' + messages.join(' ');
  } else {
    hintsBox.style.display = 'none';
    hintsBox.innerHTML = '';
  }
}

/* Omdraaien */
function updateSwapVisibility(){ document.getElementById('btn-swap').style.display = allowSwap?'inline-block':'none'; }
function swapOperands(){
  if(!current) return;
  const tmp=current.a; current.a=current.b; current.b=tmp;
  current.productRaw=String(Number(current.a.raw)*Number(current.b.raw));
  current.productDecs=current.a.decs+current.b.decs;
  const aShown=formatWithComma(current.a.raw,current.a.decs);
  const bShown=formatWithComma(current.b.raw,current.b.decs);
  document.getElementById('task').textContent = `${aShown} Ã— ${bShown} =`;
  document.getElementById('answer').value=''; document.getElementById('feedback').innerHTML='';
  buildGrid(current);
}

/* Nakijken */
function checkAnswer(){
  if(!current) return;
  const fbEl=document.getElementById('feedback');

  // Reset markeringen
  document.querySelectorAll('#grid td').forEach(td=>td.classList.remove('badcell'));
  document.querySelectorAll('#grid tr.sum-blink').forEach(tr=>tr.classList.remove('sum-blink'));

  const correct=formatWithComma(current.productRaw,current.productDecs);
  const correctDigits=onlyDigits(correct);
  const userRaw=document.getElementById('answer').value;
  const user=normalizeStudent(userRaw);

  if(!user||!/\d/.test(user)){ fbEl.innerHTML=`<div class="warnmsg">Vul eerst je eindantwoord in en probeer opnieuw.</div>`; return; }

  const userDigits=onlyDigits(user);
  const isExact=(normalizeStudent(user)===normalizeStudent(correct));
  const isDigitsOnly=(userDigits===correctDigits);

  // Somâ€‘rij digits (zoals leerling invult)
  const table=document.getElementById('grid-table');
  let sumStr=''; let rSum=null; let cols=null;
  if(table){
    cols=Number(table.getAttribute('data-cols'));
    const inputs=table.querySelectorAll('input[data-r]'); let maxR=-Infinity;
    inputs.forEach(inp=>{ const rv=Number(inp.getAttribute('data-r')); if(!Number.isNaN(rv)&&rv>maxR) maxR=rv; });
    rSum=maxR;
    const parts=[];
    for(let c=1;c<cols;c++){ const inp=table.querySelector(`input[data-r="${rSum}"][data-c="${c}"]`); if(inp) parts.push((inp.value||'').replace(/[^\d]/g,'')); }
    sumStr=parts.join('').replace(/[^\d]/g,'');
  }

  if(isExact){
    fbEl.innerHTML=`<div class="okmsg">âœ” Correct! Antwoord: <b>${correct}</b></div>`;
    runPerCellChecks(); return;
  }

  if(!sumStr || sumStr!==userDigits){
    fbEl.innerHTML=`<div class="warnmsg">Laat je antwoord overeenkomen met de onderste somâ€‘rij.</div>`;
    if(table && rSum!==null){
      const anyCell=table.querySelector(`input[data-r="${rSum}"][data-c="1"]`);
      const sumTr=anyCell?anyCell.closest('tr'):null;
      if(sumTr) sumTr.classList.add('sum-blink');
    }
    return;
  }

  // Niet exact, somâ€‘rij == antwoord â†’ inhoudelijke feedback + perâ€‘cel checks
  fbEl.innerHTML = isDigitsOnly
    ? `<div class="warnmsg">De cijfers kloppen, maar de <b>komma</b> lijkt verkeerd geplaatst. Correct: <b>${correct}</b>.</div>`
    : `<div class="errmsg">Niet juist. Correct: <b>${correct}</b>.</div>`;
  runPerCellChecks();

  function runPerCellChecks(){
    const table=document.getElementById('grid-table'); if(!table) return;
    const cols=Number(table.getAttribute('data-cols'));
    const aStr=table.getAttribute('data-a'), bStr=table.getAttribute('data-b');
    const aLen=aStr.length, bLen=bStr.length;
    const aDigits=aStr.split('').map(d=>Number(d));
    const bDigits=bStr.split('').map(d=>Number(d));
    const markBad=(r,c)=>{const inp=table.querySelector(`input[data-r="${r}"][data-c="${c}"]`); if(inp) inp.parentElement.classList.add('badcell');};
    const valAt=(r,c)=>{const inp=table.querySelector(`input[data-r="${r}"][data-c="${c}"]`); return inp?(inp.value||''):'';};

    // Tussenproducten
    for(let r=0;r<bLen;r++){
      const k=r; const coreStart=cols-k-aLen; const coreEnd=cols-k-1;
      const bDigit=bDigits[bLen-1-r]; let carry=0; const coreDigits=new Array(aLen);
      for(let j=aLen-1;j>=0;j--){ const prod=bDigit*aDigits[j]+carry; coreDigits[j]=prod%10; carry=Math.floor(prod/10); }
      for(let c=coreStart,idx=0;c<=coreEnd;c++,idx++){ const want=String(coreDigits[idx]); const got=valAt(r,c); if(got!==want) markBad(r,c); }
      for(let c=cols-k;c<cols;c++){ const want='0'; const got=valAt(r,c); if(got!==want) markBad(r,c); }
    }

    // Somâ€‘rij
    const rSumLocal=bLen; const prod=String(current.productRaw); const L=prod.length;
    for(let c=1;c<cols;c++){
      const offset=(cols-1)-c; const idx=L-1-offset;
      if(idx>=0){ const want=prod[idx]; const got=valAt(rSumLocal,c); if(got!==want) markBad(rSumLocal,c); }
    }
  }
}

/* Events */
function updateSwapVisibility(){ document.getElementById('btn-swap').style.display = allowSwap?'inline-block':'none'; }

window.addEventListener('DOMContentLoaded', ()=>{
  const sel=document.getElementById('difficulty');
  const chkDec=document.getElementById('allowDec');
  const chkFill=document.getElementById('prefillOperands');
  const chkSwap=document.getElementById('allowSwap');
  const btnSwap=document.getElementById('btn-swap');

  sel.addEventListener('change',()=>{ currentDiff=sel.value; newExercise(); });
  chkDec.addEventListener('change',()=>{ allowDec=chkDec.checked; newExercise(); });
  chkFill.addEventListener('change',()=>{ prefillOperands=chkFill.checked; buildGrid(current); });
  chkSwap.addEventListener('change',()=>{ allowSwap=chkSwap.checked; updateSwapVisibility(); });

  document.getElementById('btn-new').addEventListener('click', newExercise);
  document.getElementById('btn-check').addEventListener('click', checkAnswer);
  btnSwap.addEventListener('click', swapOperands);

  // Enter = Nakijken
  document.getElementById('answer').addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); checkAnswer(); } });

  // Start
  prefillOperands=false;
  allowSwap=false;
  updateSwapVisibility();
  newExercise();
});
</script>
</body>
</html>
